<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Fragment那点事④mAdded和mActive · Shell's Blog</title><meta name="description" content="Fragment那点事④mAdded和mActive - shell"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/logo.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Shell's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://github.com/shellljx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://weibo.com/licrafter" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Fragment那点事④mAdded和mActive</h1><div class="post-info">Jun 3, 2017</div><div class="post-content"><blockquote>
<p>文章里所有分析都是根据Android Sdk 25.3.1 v4包</p>
<p>资料链接 <a href="https://stackoverflow.com/questions/25695960/difference-between-madded-mactive-in-source-code-of-support-fragmentmanager" target="_blank" rel="external">StackOverFlow</a>、<a href="https://github.com/kgleong/software-engineering/wiki/Fragment-Manager#madded-and-mactive-fragment-lists" target="_blank" rel="external">mAdded and mActive Fragment Lists</a></p>
</blockquote>
<p>经过前面几篇对 FragmentManager 源码的分析，对 <code>mAdded</code> 和 <code>mActive</code> 这两个属性有了一定的理解，下面是在 StackOverFlow 上的一个问题，详细的总结了这两个属性的具体差异。<br><a id="more"></a><br><strong>mAdded:</strong></p>
<ol>
<li>包含了所有已经 added 并且没有被从 Activity 中 removed 和 detached 的 Fragments。</li>
<li>这些 Fragment 在视图交互上有如下特性:<ul>
<li>对下面事件作出反应:<ul>
<li>低内存事件</li>
<li>configuration changes (比如屏幕旋转)</li>
</ul>
</li>
<li>展示自定义 menu 并对 menu 的点击作出回应 <code>onMenuItemSelected()</code>。</li>
<li>Fragment 的生命周期响应它宿主 Activity 的生命周期</li>
</ul>
</li>
<li>不在 <code>mAdded</code> 中的 Fragments 不能对事件作出相应和展示自定义的 menu。</li>
</ol>
<p><strong>mActive:</strong></p>
<p><code>mAdded</code> 的一个超集，是绑定到一个 Activity 上的所有 Fragment。包括返回栈中所有的通过任何 <code>FragmentTransaction</code> 添加的 Fragments。这是非常重要的因为如下原因:</p>
<ul>
<li>当一个 Activity 要保存它的 State 时，它必须保存它所有 Fragment 的状态，因为 <code>mActive</code> 保存了所有 Fragment，所以系统只要存储这个列表里的 Fragment 的状态就好了。而<code>mAdded</code> 只是被序列化成一个整形数组，每个元素指向 Fragment 在 <code>mActive</code> 中的下标位置(这块在前面 Fragment 的存储与恢复中分析到了)。</li>
<li>在恢复 Activity 的状态时，FragmentManager 的状态也会被恢复，<code>mActive</code> 列表就可以被用来恢复 <code>mAdded</code> 列表，因为保存状态的时候<code>mAdded</code> 被简单的保存为整形数组。</li>
<li>当一个 Activity 经历它的各生命周期时，它必须引起所有绑定的 Fragment 经历各自的生命周期。<ul>
<li>该 Activity 的 FragmentManager 有义务去引导所有 Fragemnt 转换到正确的状态，这其中包括屏幕上可见的 Fragment 的 View 层级的初始化，并且调用正确的生命周期函数。</li>
<li>为了确保完整，FragmentManager 将遍历<code>mActive</code> 中所有的 Fragment，而不仅仅是 <code>mAdded</code>。</li>
</ul>
</li>
<li>它持有所有 BackStack 返回栈引用的对象。<ul>
<li>这确保了返回栈中对 Fragment 操作的回滚能够实现。</li>
</ul>
</li>
</ul>
<p><strong>什么情况下这两个 Fragment 的列表会变动呢？</strong></p>
<ul>
<li><p><strong>mAdded</strong></p>
<ul>
<li>如果一个 Fragment 被添加到 Activity 中，那么这个 Fragment 会被 <strong>added</strong> 到该列表。</li>
<li>Fragment 被从该列表中移除:<ul>
<li>Fragment 被从 Activity 中 removed。</li>
<li>Fragment 从 Activity 中 detached。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>mActive:</strong></p>
<ul>
<li>如果一个 Fragment 被添加到 Activity 中，那么这个 Fragment 会被 <strong>added</strong> 到该列表。</li>
<li><strong>只有</strong>在下面这两种情况 Fragment 才会被从该列表中移除:<ul>
<li>Fragment 被从 Activity 中移除，并且没有在返回栈中。</li>
<li>一个 transaction 从返回栈中被 pop 出来、 Fragment 的 add 或者 replace 操作被逆向，即返回栈不再持有该 Fragment。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>结论</strong></p>
<p><code>mAdded</code> 是 <strong>alive</strong> in a sense (在感官上存活的)，而 <code>mActive</code> 是所有绑定在 Activity 上的 Framgent 列表。<code>mActive</code> 包括 <strong>alive</strong> Fragments (<code>mAdded</code>) 和 <strong>freeze dried</strong> (冷冻储存) Fragments (仍然在返回栈中等待被恢复)。</p>
<p>继续对比活着的和冷冻储存的实体的区别：当 activities 触发回调函数比如 <code>onConfigurationChanged()</code> 活着 <code>onLowMemory()</code>，真正关系这些回调事件的只是活着的 Fragments。</p>
<p>所以你会发现在 <code>FragmentManagerImpl</code> 回调只会遍历 <code>mAdded</code> 即活着的 Fragments。</p>
<p><code>fragmentManager.dispatchLowMemory()</code> 在 <code>activity.onLowMemory()</code> 中被调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchLowMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mAdded != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mAdded.size(); i++) &#123;</div><div class="line">            Fragment f = mAdded.get(i);</div><div class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</div><div class="line">                f.performLowMemory();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/03/Fragment那点事③保存与恢复/" class="prev">上一篇</a><a href="/2017/06/03/Fragment那点事⑤保存与恢复实践/" class="next">下一篇</a></div><div data-thread-key="2017/06/03/Fragment那点事④mAdded和mActive/" data-title="Fragment那点事④mAdded和mActive" data-url="http://yoursite.com/2017/06/03/Fragment那点事④mAdded和mActive/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"[object Object]"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">shell</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>